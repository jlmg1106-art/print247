import React, { useMemo, useState } from 'react';
import { View, Text, StyleSheet, TouchableOpacity, Platform, ScrollView, TextInput, Alert } from 'react-native';
import * as DocumentPicker from 'expo-document-picker';
import { ArrowLeft, Upload, Info, Truck } from 'lucide-react-native';

import { Buffer } from 'buffer';
import { useTranslation } from 'react-i18next';
import { useOrder } from '../contexts/OrderContext';
import { PDFDocument } from 'pdf-lib';
import * as FileSystem from 'expo-file-system';

type Picked = {
  name: string;
  uri: string;
  size?: number;
  mimeType?: string;
  pages?: number; // ✅ páginas (PDF real, imágenes=1)
};

const MAX_FILES = 5;

function extOf(name: string) {
  return (name.split('.').pop()?.toLowerCase() || '');
}

function isAllowed(name: string) {
  const ext = extOf(name);
  return ['pdf', 'doc', 'docx', 'jpg', 'jpeg', 'png', 'tiff', 'psd'].includes(ext);
}

async function getPdfPageCount(uri: string) {
  // En Expo, fetch(uri) falla mucho con file:// o content://
  // Leemos el archivo como base64 y lo convertimos a bytes para pdf-lib
  const b64 = await FileSystem.readAsStringAsync(uri, { encoding: FileSystem.EncodingType.Base64 });
  const bytes = Uint8Array.from(Buffer.from(b64, 'base64'));
  const pdf = await PDFDocument.load(bytes);
  return pdf.getPageCount();
}

// Delivery: $10 base para primeras 20 millas, luego $0.60 por milla extra
function calcDeliveryFee(miles: number) {
  if (!Number.isFinite(miles) || miles <= 0) return 0;
  if (miles <= 20) return 10;
  return 10 + (miles - 20) * 0.6;
}

export default function UploadFiles() {
  const router = useRouter();
  const { t } = useTranslation();
  const order = useOrder();

  const [files, setFiles] = useState<Picked[]>([]);
  const [deliveryEnabled, setDeliveryEnabled] = useState(false);
  const [deliveryAddress, setDeliveryAddress] = useState('');
  const [deliveryMiles, setDeliveryMiles] = useState<string>(''); // texto para input
  const [notes, setNotes] = useState('');

  const countLabel = `${files.length} / ${MAX_FILES}`;

  const canContinue = useMemo(() => files.length > 0 && files.length <= MAX_FILES, [files.length]);

  const deliveryFee = useMemo(() => {
    const miles = Number(deliveryMiles || 0);
    return deliveryEnabled ? calcDeliveryFee(miles) : 0;
  }, [deliveryEnabled, deliveryMiles]);

  const pickFiles = async () => {
    if (files.length >= MAX_FILES) return;

    const res = await DocumentPicker.getDocumentAsync({
      multiple: true,
      type: [
        'application/pdf',
        'image/*',
        'application/msword',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        '*/*',
      ],
      copyToCacheDirectory: true,
    });

    if (res.canceled) return;

    const incomingRaw = (res.assets || [])
      .map((a) => ({
        name: a.name ?? 'file',
        uri: a.uri,
        size: a.size,
        mimeType: a.mimeType,
      }))
      .filter((f) => isAllowed(f.name));

    // ✅ calcular páginas para PDFs
    const incoming: Picked[] = await Promise.all(
      incomingRaw.map(async (f) => {
        const ext = extOf(f.name);

        // PDF: contar páginas reales
        if (ext === 'pdf') {
          try {
            const pages = await getPdfPageCount(f.uri);
            return { ...f, pages };
          } catch (e) {
            return { ...f, pages: undefined };
          }
        }

        // Imágenes: 1 página
        if (['jpg', 'jpeg', 'png', 'tiff'].includes(ext)) {
          return { ...f, pages: 1 };
        }

        // DOC/DOCX/PSD: no contamos por ahora
        return { ...f, pages: undefined };
      })
    );

    const merged = [...files, ...incoming].slice(0, MAX_FILES);
    setFiles(merged);
  };

  const onContinue = () => {
    // Validaciones de delivery si está activado
    if (deliveryEnabled) {
      const miles = Number(deliveryMiles || 0);
      if (!deliveryAddress.trim()) {
        Alert.alert('Delivery', 'Por favor ingresa la dirección de entrega.');
        return;
      }
      if (!Number.isFinite(miles) || miles <= 0) {
        Alert.alert('Delivery', 'Por favor ingresa la distancia en millas (número mayor a 0).');
        return;
      }
    }

    try {
      // Guardamos todo en el contexto (OrderContext)
      const delivery = {
        enabled: deliveryEnabled,
        address: deliveryAddress.trim(),
        miles: Number(deliveryMiles || 0),
        fee: deliveryFee,
      };

      if ((order as any)?.setFiles) (order as any).setFiles(files);
      if ((order as any)?.setNotes) (order as any).setNotes(notes);

      // Guardar delivery en formas distintas por compatibilidad
      if ((order as any)?.setDelivery) (order as any).setDelivery(delivery);
      if ((order as any)?.setUploadData) (order as any).setUploadData({ files, delivery, notes });

      // También lo dejamos como campo directo por si tu summary lo lee así:
      (order as any).delivery = delivery;
    } catch (e) {}

    router.push('/order-summary');
  };

  return (
    <View style={styles.page}>
      <View style={styles.topBar}>
        <TouchableOpacity onPress={() => router.back()} style={styles.backBtn} activeOpacity={0.7}>
          <ArrowLeft color="#0B5FFF" size={22} />
        </TouchableOpacity>
        <Text style={styles.topTitle}>upload-files</Text>
      </View>

      <ScrollView contentContainerStyle={styles.content} showsVerticalScrollIndicator={false}>
        <View style={styles.heroIcon}>
          <View style={styles.heroCircle}>
            <Upload size={34} color="#0B5FFF" />
          </View>
        </View>

        <Text style={styles.h1}>{t('upload.title', 'Cargar Archivos')}</Text>
        <Text style={styles.sub}>{t('upload.subtitle', 'Sube tus documentos o fotografías para imprimir')}</Text>

        <View style={styles.infoBox}>
          <Info size={18} color="#0B5FFF" />
          <View style={{ flex: 1 }}>
            <Text style={styles.infoText}>
              {t('upload.formats', 'Formatos aceptados: PDF, DOC, DOCX, JPG, PNG, TIFF, PSD')}
            </Text>
            <Text style={styles.infoSub}>{t('upload.max', 'Máximo 5 archivos por pedido')}</Text>
          </View>
        </View>

        <TouchableOpacity style={styles.dropzone} activeOpacity={0.9} onPress={pickFiles}>
          <Upload size={26} color="#0B5FFF" />
          <Text style={styles.dropTitle}>{t('upload.select', 'Seleccionar Archivo')}</Text>
          <Text style={styles.dropCount}>{countLabel}</Text>
        </TouchableOpacity>

        {/* Delivery */}
        <View style={styles.card}>
          <View style={styles.cardHeader}>
            <Truck size={20} color="#0B5FFF" />
            <Text style={styles.cardTitle}>{t('upload.deliveryTitle', 'Servicio de Delivery')}</Text>
          </View>
          <Text style={styles.cardDesc}>
            {t('upload.deliveryDesc', '¿Necesitas que entreguemos tu pedido en una ubicación específica?')}
          </Text>

          <TouchableOpacity
            style={styles.checkRow}
            onPress={() => setDeliveryEnabled((v) => !v)}
            activeOpacity={0.85}
          >
            <View style={[styles.checkbox, deliveryEnabled && styles.checkboxOn]} />
            <Text style={styles.checkText}>{t('upload.deliveryYes', 'Sí, necesito servicio de delivery')}</Text>
          </TouchableOpacity>

          {deliveryEnabled ? (
            <View style={{ marginTop: 14 }}>
              <Text style={styles.fieldLabel}>{t('upload.deliveryAddress', 'Dirección de Entrega *')}</Text>
              <TextInput
                value={deliveryAddress}
                onChangeText={setDeliveryAddress}
                placeholder={t('upload.deliveryAddressPh', 'Ingresa la dirección completa de entrega...')}
                placeholderTextColor="#9AA3AF"
                style={styles.input}
              />

              <Text style={styles.fieldLabel}>{t('upload.deliveryMiles', 'Distancia Estimada (millas) *')}</Text>
              <TextInput
                value={deliveryMiles}
                onChangeText={setDeliveryMiles}
                placeholder="0"
                placeholderTextColor="#9AA3AF"
                style={styles.input}
                keyboardType="numeric"
              />

              <Text style={styles.rateText}>
                {t('upload.deliveryRate', 'Tarifa: $10 USD (primeras 20 millas) + $0.60 USD por milla adicional')}
              </Text>

              <Text style={styles.feeText}>
                {t('upload.deliveryFee', 'Costo Delivery')}:{' '}
                <Text style={{ fontWeight: '900' }}>${deliveryFee.toFixed(2)} USD</Text>
              </Text>
            </View>
          ) : null}
        </View>

        {/* Notas */}
        <Text style={styles.section}>{t('upload.notesTitle', 'Comentarios Adicionales')}</Text>
        <Text style={styles.notesHint}>{t('upload.notesHint', 'Instrucciones especiales o notas (opcional)')}</Text>
        <TextInput
          value={notes}
          onChangeText={setNotes}
          placeholder={t('upload.notesPlaceholder', 'Ej: Por favor imprimir las primeras 10 páginas a color y el resto en blanco y negro...')}
          placeholderTextColor="#9AA3AF"
          style={styles.notes}
          multiline
        />

        <View style={{ height: 120 }} />
      </ScrollView>

      <View style={styles.bottom}>
        <TouchableOpacity
          style={[styles.cta, !canContinue && styles.ctaDisabled]}
          onPress={onContinue}
          disabled={!canContinue}
          activeOpacity={0.9}
        >
          <Text style={styles.ctaText}>{t('upload.summary', 'Ver Resumen del Pedido')}</Text>
        </TouchableOpacity>
      </View>
    </View>
  );
}

const styles = StyleSheet.create({
  page: { flex: 1, backgroundColor: '#FFFFFF' },

  topBar: {
    paddingTop: Platform.OS === 'ios' ? 54 : 18,
    paddingBottom: 12,
    paddingHorizontal: 14,
    borderBottomWidth: 1,
    borderBottomColor: '#EEF2F7',
    flexDirection: 'row',
    alignItems: 'center',
    gap: 10,
  },
  backBtn: { paddingVertical: 6, paddingHorizontal: 6 },
  topTitle: { fontSize: 16, fontWeight: '800', color: '#111827', flex: 1, textAlign: 'center', marginRight: 34 },

  content: { paddingHorizontal: 18, paddingTop: 16 },

  heroIcon: { alignItems: 'center', marginTop: 10 },
  heroCircle: {
    width: 74,
    height: 74,
    borderRadius: 37,
    backgroundColor: '#EAF1FF',
    alignItems: 'center',
    justifyContent: 'center',
  },

  h1: { marginTop: 14, fontSize: 34, fontWeight: '900', color: '#111827', textAlign: 'center' },
  sub: { marginTop: 8, fontSize: 15, color: '#6B7280', textAlign: 'center' },

  infoBox: {
    marginTop: 16,
    borderRadius: 14,
    backgroundColor: '#EAF1FF',
    padding: 14,
    flexDirection: 'row',
    gap: 10,
    alignItems: 'flex-start',
  },
  infoText: { fontSize: 14, fontWeight: '800', color: '#0B5FFF' },
  infoSub: { marginTop: 6, fontSize: 13, fontWeight: '700', color: '#2563EB' },

  dropzone: {
    marginTop: 18,
    borderRadius: 18,
    borderWidth: 2,
    borderStyle: 'dashed',
    borderColor: '#0B5FFF',
    paddingVertical: 28,
    alignItems: 'center',
    justifyContent: 'center',
    gap: 10,
    backgroundColor: '#FFFFFF',
  },
  dropTitle: { fontSize: 20, fontWeight: '900', color: '#0B5FFF' },
  dropCount: { fontSize: 14, fontWeight: '800', color: '#6B7280' },

  card: {
    marginTop: 18,
    borderRadius: 18,
    borderWidth: 1,
    borderColor: '#E5E7EB',
    backgroundColor: '#FFFFFF',
    padding: 16,
  },
  cardHeader: { flexDirection: 'row', alignItems: 'center', gap: 10 },
  cardTitle: { fontSize: 20, fontWeight: '900', color: '#111827' },
  cardDesc: { marginTop: 8, color: '#6B7280', fontSize: 14, fontWeight: '700' },

  checkRow: { marginTop: 14, flexDirection: 'row', alignItems: 'center', gap: 10 },
  checkbox: {
    width: 22,
    height: 22,
    borderRadius: 6,
    borderWidth: 2,
    borderColor: '#CBD5E1',
    backgroundColor: '#FFFFFF',
  },
  checkboxOn: { borderColor: '#0B5FFF', backgroundColor: '#0B5FFF' },
  checkText: { fontSize: 15, fontWeight: '800', color: '#111827' },

  fieldLabel: { marginTop: 14, fontSize: 14, fontWeight: '900', color: '#111827' },
  input: {
    marginTop: 8,
    borderRadius: 14,
    borderWidth: 1,
    borderColor: '#E5E7EB',
    padding: 14,
    fontSize: 15,
    fontWeight: '700',
    color: '#111827',
    backgroundColor: '#FFFFFF',
  },
  rateText: { marginTop: 10, fontSize: 13, fontWeight: '800', color: '#2563EB' },
  feeText: { marginTop: 8, fontSize: 14, fontWeight: '800', color: '#111827' },

  section: { marginTop: 18, fontSize: 22, fontWeight: '900', color: '#111827' },
  notesHint: { marginTop: 6, fontSize: 14, fontWeight: '700', color: '#6B7280' },
  notes: {
    marginTop: 10,
    borderRadius: 14,
    borderWidth: 1,
    borderColor: '#E5E7EB',
    padding: 14,
    minHeight: 110,
    fontSize: 15,
    fontWeight: '700',
    color: '#111827',
    backgroundColor: '#FFFFFF',
  },

  bottom: {
    position: 'absolute',
    left: 0,
    right: 0,
    bottom: 0,
    padding: 16,
    paddingBottom: Platform.OS === 'ios' ? 28 : 16,
    borderTopWidth: 1,
    borderTopColor: '#EEF2F7',
    backgroundColor: '#FFFFFF',
  },
  cta: { height: 56, borderRadius: 14, backgroundColor: '#0B5FFF', alignItems: 'center', justifyContent: 'center' },
  ctaDisabled: { backgroundColor: '#CBD5E1' },
  ctaText: { color: '#FFFFFF', fontSize: 18, fontWeight: '900' },
});
