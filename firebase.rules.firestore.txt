rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    match /orders/{orderId} {

      // CREATE: anyone can submit a new order with allowed fields and valid status
      allow create: if
        request.resource.data.status in ['submitted', 'pending']
        && request.resource.data.keys().hasAll([
          'orderType', 'customerName', 'customerPhone', 'status', 'createdAt'
        ])
        && request.resource.data.keys().hasOnly([
          'orderType',
          'customerName',
          'customerPhone',
          'customerEmail',
          'customerUid',
          'status',
          'createdAt',
          'updatedAt',
          'printConfig',
          'photoConfig',
          'posterConfig',
          'delivery',
          'locationId',
          'locationName',
          'filesMetadata',
          'files',
          'estimatedTotal',
          'notes'
        ]);

      // READ own order: allow if the authenticated user's UID matches customerUid
      // TODO: customerUid is not yet stored by the client during order creation.
      //       Once implemented, this rule will let clients read their own orders.
      allow read: if
        request.auth != null
        && resource.data.customerUid == request.auth.uid;

      // ADMIN read/update: users with the custom "admin" claim can read and update any order
      allow read, update: if
        request.auth != null
        && request.auth.token.admin == true;

      // Public read of all orders is explicitly denied (no blanket allow read)

      // UPDATE by client: denied for now
      // TODO: consider allowing clients to cancel their own order
      //       (update status to 'cancelled') if customerUid matches.

      // DELETE: denied for everyone (orders are never deleted from client side)
      allow delete: if false;
    }

    // Deny access to all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
