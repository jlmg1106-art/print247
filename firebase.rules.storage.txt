rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    match /orders/{orderId}/{fileName} {

      // ⚠️  MVP WARNING: writes are currently open to ALL users (no auth check).
      //     This is intentional for the MVP phase because the app does not yet
      //     require user sign-in before placing an order.
      //
      //     BEFORE PRODUCTION: replace the write rule below with:
      //       allow write: if request.auth != null;
      //     or even stricter:
      //       allow write: if request.auth != null
      //                    && request.resource.size < 50 * 1024 * 1024;
      //
      allow write: if true;

      // READ: only admins or the file owner (TODO: owner check requires customerUid mapping)
      allow read: if
        request.auth != null
        && request.auth.token.admin == true;

      // TODO: allow read for the order owner once customerUid is stored:
      //   allow read: if request.auth != null
      //                && firestore.get(/databases/(default)/documents/orders/$(orderId)).data.customerUid == request.auth.uid;
    }

    // Deny everything else
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
